{% extends 'base.html' %}
{% load employee_filters %}

{% block title %}User Management | AssetTrack{% endblock %}

{% block content %}
<div class="w-full px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-white">User Management</h1>
                <p class="text-slate-400 mt-2">Manage system users, roles, and permissions</p>
            </div>
            <div class="flex space-x-3">
                <a href="{% url 'assets:admin_dashboard' %}" class="inline-flex items-center px-4 py-2 border border-slate-600 text-sm font-medium rounded-md text-slate-300 bg-slate-700 hover:bg-slate-600">
                    <i data-lucide="arrow-left" class="mr-2 h-4 w-4"></i>
                    Back to Admin
                </a>
                {% if user.is_superuser %}
                <a href="{% url 'assets:add_user' %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i data-lucide="plus" class="mr-2 h-4 w-4"></i>
                    Add User
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- User Statistics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-slate-800 rounded-xl p-6 shadow-lg border border-slate-700">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-slate-400">Total Users</p>
                    <p class="mt-1 text-3xl font-semibold text-white">{{ users.count }}</p>
                </div>
                <div class="p-3 rounded-lg bg-blue-900/20 text-blue-400">
                    <i data-lucide="users" class="h-6 w-6"></i>
                </div>
            </div>
        </div>

        <div class="bg-slate-800 rounded-xl p-6 shadow-lg border border-slate-700">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-slate-400">Superusers</p>
                    <p class="mt-1 text-3xl font-semibold text-white">{{ users|length|add:"-1" }}</p>
                </div>
                <div class="p-3 rounded-lg bg-red-900/20 text-red-400">
                    <i data-lucide="shield" class="h-6 w-6"></i>
                </div>
            </div>
        </div>

        <div class="bg-slate-800 rounded-xl p-6 shadow-lg border border-slate-700">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-slate-400">Active Users</p>
                    <p class="mt-1 text-3xl font-semibold text-white">{{ users|length|add:"-1" }}</p>
                </div>
                <div class="p-3 rounded-lg bg-green-900/20 text-green-400">
                    <i data-lucide="check-circle" class="h-6 w-6"></i>
                </div>
            </div>
        </div>

        <div class="bg-slate-800 rounded-xl p-6 shadow-lg border border-slate-700">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-slate-400">Staff Users</p>
                    <p class="mt-1 text-3xl font-semibold text-white">{{ users|length|add:"-1" }}</p>
                </div>
                <div class="p-3 rounded-lg bg-yellow-900/20 text-yellow-400">
                    <i data-lucide="user-check" class="h-6 w-6"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="bg-slate-800 rounded-xl shadow-lg border border-slate-700">
        <div class="px-6 py-5 border-b border-slate-700">
            <h2 class="text-lg font-semibold text-white">System Users</h2>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-700">
                <thead class="bg-slate-800">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">User</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Role</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Last Login</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-slate-800 divide-y divide-slate-700">
                    {% for user in users %}
                    <tr class="hover:bg-slate-700/50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="h-10 w-10 rounded-full bg-blue-600 flex items-center justify-center">
                                    <span class="text-white font-medium text-sm">
                                        {{ user.first_name|first|default:user.username|first|upper }}{{ user.last_name|first|default:""|upper }}
                                    </span>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-white">
                                        {{ user.get_full_name|default:user.username }}
                                    </div>
                                    <div class="text-sm text-slate-400">{{ user.email }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex flex-col space-y-1">
                                {% if user.is_superuser %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400">
                                    Superuser
                                </span>
                                {% elif user.is_staff %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400">
                                    Staff
                                </span>
                                {% else %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-slate-100 text-slate-800 dark:bg-slate-900/30 dark:text-slate-400">
                                    User
                                </span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if user.is_active %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">
                                Active
                            </span>
                            {% else %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400">
                                Inactive
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">
                            {{ user.last_login|date:"M d, Y H:i"|default:"Never" }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            {% if request.user.is_superuser %}
                            <div class="flex items-center justify-end space-x-2">
                                <a href="{% url 'assets:edit_user' user.id %}" class="text-blue-500 hover:text-blue-700" title="Edit User">
                                    <i data-lucide="edit" class="h-4 w-4"></i>
                                </a>
                                <a href="{% url 'assets:change_user_password' user.id %}" class="text-yellow-500 hover:text-yellow-700" title="Change Password">
                                    <i data-lucide="key" class="h-4 w-4"></i>
                                </a>
                                {% if user != request.user %}
                                <a href="{% url 'assets:toggle_user_status' user.id %}" class="{% if user.is_active %}text-orange-500 hover:text-orange-700{% else %}text-green-500 hover:text-green-700{% endif %}" title="{% if user.is_active %}Deactivate{% else %}Activate{% endif %} User">
                                    <i data-lucide="{% if user.is_active %}user-x{% else %}user-check{% endif %}" class="h-4 w-4"></i>
                                </a>
                                <a href="{% url 'assets:delete_user' user.id %}" class="text-red-500 hover:text-red-700" title="Delete User" onclick="return confirm('Are you sure you want to delete this user? This action cannot be undone.')">
                                    <i data-lucide="trash-2" class="h-4 w-4"></i>
                                </a>
                                {% endif %}
                            </div>
                            {% else %}
                            <div class="text-slate-500 text-sm">
                                <i data-lucide="lock" class="inline h-4 w-4 mr-1"></i>
                                No access
                            </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-slate-400">
                            No users found.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Initialize Lucide icons
document.addEventListener('DOMContentLoaded', function() {
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>
{% endblock %}
