{% extends "base.html" %}

{% block title %}AI Assistant | AssetTrack{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-slate-800 rounded-xl shadow-lg border border-slate-700">
        <!-- Header -->
        <div class="px-6 py-4 border-b border-slate-700">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-white">AI Assistant</h1>
                    <p class="text-slate-400 text-sm">Ask me anything about AssetTrack, employees, assets, or handovers</p>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="text-sm text-green-400">Online</span>
                </div>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="h-96 overflow-y-auto px-6 py-4" id="chat-container">
            <div class="space-y-4" id="chat-messages">
                <!-- Welcome message -->
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                        <i data-lucide="bot" class="h-4 w-4 text-white"></i>
                    </div>
                    <div class="bg-slate-700 rounded-lg p-3 max-w-md">
                        <p class="text-white text-sm">
                            ðŸ‘‹ Hello! I'm your AI assistant for AssetTrack. I can help you with:
                            <br>â€¢ Finding assets and employees
                            <br>â€¢ Explaining handover processes
                            <br>â€¢ Answering questions about the system
                            <br>â€¢ Providing insights and analytics
                            <br><br>What would you like to know?
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="px-6 py-4 border-t border-slate-700">
            <form id="chat-form" class="flex space-x-3">
                <input 
                    type="text" 
                    id="chat-input" 
                    placeholder="Ask me anything about AssetTrack..." 
                    class="flex-1 px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    autocomplete="off"
                >
                <button 
                    type="submit" 
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                >
                    <i data-lucide="send" class="h-4 w-4"></i>
                </button>
            </form>
            
            <!-- Quick Actions -->
            <div class="mt-3 flex flex-wrap gap-2">
                <button class="quick-action px-3 py-1 bg-slate-700 text-slate-300 rounded-full text-xs hover:bg-slate-600 transition-colors">
                    Show all laptops
                </button>
                <button class="quick-action px-3 py-1 bg-slate-700 text-slate-300 rounded-full text-xs hover:bg-slate-600 transition-colors">
                    Find employees in Bremen
                </button>
                <button class="quick-action px-3 py-1 bg-slate-700 text-slate-300 rounded-full text-xs hover:bg-slate-600 transition-colors">
                    Pending handovers
                </button>
                <button class="quick-action px-3 py-1 bg-slate-700 text-slate-300 rounded-full text-xs hover:bg-slate-600 transition-colors">
                    System insights
                </button>
            </div>
        </div>
    </div>
</div>

<!-- AI Assistant Floating Button (for other pages) -->
<div id="ai-assistant-btn" class="fixed bottom-6 right-6 z-50 hidden">
    <button 
        onclick="toggleAIChat()" 
        class="w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center group"
        title="AI Assistant"
    >
        <i data-lucide="message-circle" class="h-6 w-6 group-hover:scale-110 transition-transform"></i>
    </button>
</div>

<!-- AI Chat Modal (for other pages) -->
<div id="ai-chat-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-slate-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-96">
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-slate-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-white">AI Assistant</h3>
                <button onclick="toggleAIChat()" class="text-slate-400 hover:text-white">
                    <i data-lucide="x" class="h-5 w-5"></i>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="p-6">
                <div class="h-64 overflow-y-auto mb-4" id="modal-chat-messages">
                    <div class="flex items-start space-x-3">
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                            <i data-lucide="bot" class="h-4 w-4 text-white"></i>
                        </div>
                        <div class="bg-slate-700 rounded-lg p-3 max-w-md">
                            <p class="text-white text-sm">How can I help you today?</p>
                        </div>
                    </div>
                </div>
                
                <form id="modal-chat-form" class="flex space-x-3">
                    <input 
                        type="text" 
                        id="modal-chat-input" 
                        placeholder="Ask me anything..." 
                        class="flex-1 px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        autocomplete="off"
                    >
                    <button 
                        type="submit" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        <i data-lucide="send" class="h-4 w-4"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// AI Chat functionality
let isTyping = false;

// Main chat form
document.getElementById('chat-form').addEventListener('submit', function(e) {
    e.preventDefault();
    sendMessage('chat-input', 'chat-messages');
});

// Modal chat form
document.getElementById('modal-chat-form').addEventListener('submit', function(e) {
    e.preventDefault();
    sendMessage('modal-chat-input', 'modal-chat-messages');
});

// Quick action buttons
document.querySelectorAll('.quick-action').forEach(button => {
    button.addEventListener('click', function() {
        const message = this.textContent.trim();
        document.getElementById('chat-input').value = message;
        sendMessage('chat-input', 'chat-messages');
    });
});

function sendMessage(inputId, messagesId) {
    const input = document.getElementById(inputId);
    const messagesContainer = document.getElementById(messagesId);
    const message = input.value.trim();
    
    if (!message || isTyping) return;
    
    // Add user message
    addMessage(messagesContainer, message, 'user');
    input.value = '';
    
    // Show typing indicator
    showTypingIndicator(messagesContainer);
    
    // Send to AI
    fetch('{% url "assets:ai_chat" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `query=${encodeURIComponent(message)}&current_page=${window.location.pathname}`
    })
    .then(response => response.json())
    .then(data => {
        hideTypingIndicator(messagesContainer);
        
        if (data.success) {
            addMessage(messagesContainer, data.response, 'ai');
            
            // Show search results if any
            if (data.search_results && (data.search_results.assets.length > 0 || data.search_results.employees.length > 0)) {
                showSearchResults(messagesContainer, data.search_results);
            }
        } else {
            addMessage(messagesContainer, `Error: ${data.error}`, 'ai', true);
        }
    })
    .catch(error => {
        hideTypingIndicator(messagesContainer);
        addMessage(messagesContainer, `Error: ${error.message}`, 'ai', true);
    });
}

function addMessage(container, message, sender, isError = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex items-start space-x-3 ${sender === 'user' ? 'justify-end' : ''}`;
    
    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="bg-blue-600 rounded-lg p-3 max-w-md">
                <p class="text-white text-sm">${escapeHtml(message)}</p>
            </div>
            <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                <i data-lucide="user" class="h-4 w-4 text-white"></i>
            </div>
        `;
    } else {
        const iconClass = isError ? 'alert-circle' : 'bot';
        const bgClass = isError ? 'bg-red-600' : 'bg-slate-700';
        messageDiv.innerHTML = `
            <div class="w-8 h-8 ${isError ? 'bg-red-600' : 'bg-blue-600'} rounded-full flex items-center justify-center">
                <i data-lucide="${iconClass}" class="h-4 w-4 text-white"></i>
            </div>
            <div class="${bgClass} rounded-lg p-3 max-w-md">
                <p class="text-white text-sm">${escapeHtml(message)}</p>
            </div>
        `;
    }
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
    
    // Re-initialize Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

function showTypingIndicator(container) {
    isTyping = true;
    const typingDiv = document.createElement('div');
    typingDiv.className = 'flex items-start space-x-3 typing-indicator';
    typingDiv.innerHTML = `
        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
            <i data-lucide="bot" class="h-4 w-4 text-white"></i>
        </div>
        <div class="bg-slate-700 rounded-lg p-3 max-w-md">
            <div class="flex space-x-1">
                <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
        </div>
    `;
    container.appendChild(typingDiv);
    container.scrollTop = container.scrollHeight;
}

function hideTypingIndicator(container) {
    isTyping = false;
    const typingIndicator = container.querySelector('.typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function showSearchResults(container, results) {
    if (results.assets.length > 0) {
        const assetsDiv = document.createElement('div');
        assetsDiv.className = 'mt-2 p-3 bg-slate-600 rounded-lg';
        assetsDiv.innerHTML = `
            <h4 class="text-white text-sm font-medium mb-2">Found ${results.assets.length} assets:</h4>
            <div class="space-y-1">
                ${results.assets.slice(0, 3).map(asset => `
                    <div class="text-xs text-slate-300">
                        ${asset.name} (${asset.serial_number}) - ${asset.asset_type}
                    </div>
                `).join('')}
            </div>
        `;
        container.appendChild(assetsDiv);
    }
    
    if (results.employees.length > 0) {
        const employeesDiv = document.createElement('div');
        employeesDiv.className = 'mt-2 p-3 bg-slate-600 rounded-lg';
        employeesDiv.innerHTML = `
            <h4 class="text-white text-sm font-medium mb-2">Found ${results.employees.length} employees:</h4>
            <div class="space-y-1">
                ${results.employees.slice(0, 3).map(emp => `
                    <div class="text-xs text-slate-300">
                        ${emp.name} - ${emp.department}
                    </div>
                `).join('')}
            </div>
        `;
        container.appendChild(employeesDiv);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Toggle AI chat modal
function toggleAIChat() {
    const modal = document.getElementById('ai-chat-modal');
    const btn = document.getElementById('ai-assistant-btn');
    
    if (modal.classList.contains('hidden')) {
        modal.classList.remove('hidden');
        btn.classList.add('hidden');
    } else {
        modal.classList.add('hidden');
        btn.classList.remove('hidden');
    }
}

// Show AI assistant button on other pages (not the main chat page)
if (window.location.pathname !== '{% url "assets:ai_chat" %}') {
    document.getElementById('ai-assistant-btn').classList.remove('hidden');
}
</script>
{% endblock %}
